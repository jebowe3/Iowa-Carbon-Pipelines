<!doctype html>
<html lang="en" class="no-js">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Iowa CO2 Pipelines</title>

  <!-- link to Montserrat font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  <!-- leaflet css -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <!-- grouped layer control -->
  <link rel="stylesheet" href="src/leaflet.groupedlayercontrol.css" />
  <!-- for the collapsible sidebar -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />
  <link rel="stylesheet" href="src/leaflet-sidebar.css" />

  <!-- custom style here -->
  <style type="text/css">

    body,
    html {
      margin: 0;
      padding: 0;
      font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
    }

    /* Set map parameters */
    #map {
      position: fixed;
      bottom: 0px;
      width: 100%;
      top: 0px;
    }

/*
    header {
      position: fixed;
      top: 0px;
      width: 100%;
      height: 52px;
      background-color: #000000;
      box-shadow: 0px 0px 5px black;
      z-index: 800;
    }
*/
    h1 {
      color: white;
      font-size: 16px;
      display: inline-block;
      margin-top: 0.5em;
      margin-bottom: 0.0em;
      margin-left: 0.8em;
      margin-right: 0;
      font-weight: normal;
      font-family: "Montserrat";
    }

    h2 {
      font-size: 12px;
      color: white;
      display: inline-block;
      margin-top: 0.25em;
      margin-bottom: 0.0em;
      margin-left: 1.0em;
      margin-right: 0;
      font-weight: normal;
      font-family: "Montserrat";
    }

    h4 {
      font-size: 16px;
      margin: 4px;
    }

    h5 {
      font-size: 13px;
      margin: 4px;
    }

    .legend,
    .caseLegend {
      padding: 6px 8px;
      font-size: 1em;
      background: rgba(75, 75, 75, 0.8);
      color: whitesmoke;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      width: 180px;
    }

    /*
    .legend h3,
    .caseLegend h3 {
      font-size: 1.1em;
      font-weight: bold;
      line-height: 1em;
      color: whitesmoke;
      margin: 0;
    }

    .legend h3 span,
    .caseLegend h3 span {
      font-size: 1.1em;
      margin: 0 30px 0 0;
    }

    .legend ul,
    .caseLegend ul {
      list-style-type: none;
      padding: 0;
      margin: 12px 4px 0;
    }

    .legend li,
    .caseLegend li {
      height: 22px;
    }

    .legend span,
    .caseLegend span {
      width: 30px;
      height: 20px;
      float: left;
      margin-right: 10px;
    }
*/
    .legend .square {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
    }

    .legend .square.present {
      background-color: rgba(135, 206, 235, 0.5);
    }

    .legend .square.not-present {
      background-color: rgba(211, 211, 211, 0.5);
    }

    /* custom sidebar css */
      /* sidebar header */
      .sidebar-header {
        width: 100%;
      }

      /* sidebar icon */
      i {
        color: rgb(0, 0, 0);
      }

      /* sidebar about heading*/
      .about {
        color: rgb(0, 0, 0);
        font-size: 16px;
        margin-bottom: 0px;
        margin-top: 0px;
        margin-left: 0px;
      }

      /* map info */
      .details {
        font-size: 14px;
        font-weight: normal;
        margin-bottom: 0px;
        margin-top: 0px;
      }

      .introbreak {
        display: block;
        margin-bottom: 1em;
      }

  </style>

</head>

<body>
<!--
  <header>
    <h1>Iowa CO2 Pipelines</h1><br>
    <h2>Digital Scholarship & Publishing Studio, University of Iowa Libraries</h2>
  </header>
-->
  <div id="sidebar" class="sidebar collapsed">
    <div class="sidebar-tabs">
      <ul role="tablist">
        <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
      </ul>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-pane" id="home">
        <h1 class="sidebar-header">Iowa Carbon Pipelines<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1><br>
        <div><br><b>
          <h2 class="about">About This Project</h2>
        </b><br><br>
          <h3 class="details">This map is meant to help its users locate counties in Iowa that are impacted by planned carbon pipeline construction and pipeline-related ordinances. The initial map layer displays the counties in Iowa where carbon pipelines are planned for construction. Basic instructions are as follows:<br><br>1.) In the upper right corner, you can use the layer control to filter the planned pipelines by company (Navigator, Midwest, and Wolf).<br>2.) You can also use this to switch to the layer showing which counties have enacted pipeline-related ordinances.<br>3.) With this layer on, you can click counties with ordinances on the map to open ordinance-related documents in new web browser tabs.<br>4.) You can collapse this sidebar by clicking the arrow icon in its upper right corner.<br><br>This application was developed by the <a href="https://www.lib.uiowa.edu/studio/" target="_blank">University of Iowa Libraries' Digital Scholarship & Publishing Studio</a>. The locations of the planned pipelines were painstakingly digitized by researchers at the FracTracker Alliance and appear here courtesy of <a href="https://www.fractracker.org/author/ted-auch/" target="_blank">Dr. Ted Auch, the Midwest Program Director of the FracTracker Alliance</a>.</h3>
          <p style="padding-bottom:0px"></p>
        </div>
        <div id="dropdown-instructions">
          <p><b>Choose from the options in the dropdown menu to find your county of interest.</b></p>
        </div>
        <form id="map_parameters" name="map_parameters" action="#" accept-charset="utf-8" class="inlineForm"><select id="chapter-select" class="div-toggle" data-target=".my-info-1"></select></form><span class='introbreak'></span>
        <div id="sidebar-info" class="my-info-1">
          <div id="content-info" class="contentinfo hide"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- map -->
  <div id="map"></div>

  <!-- leaflet js -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <!-- d3js -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <!-- chroma -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.2.1/chroma.min.js"></script>
  <!-- grouped layer control -->
  <script src="src/leaflet.groupedlayercontrol.js"></script>
  <!-- sidebar -->
  <script src="https://cdn.jsdelivr.net/gh/jebowe3/CSV-2-Storymap/js/svg-icon.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/jebowe3/CSV-2-Storymap/js/leaflet-sidebar.js"></script>
  <!-- javascript below -->
  <script>
    // initialize the map
    const map = L.map('map');

    // add a sidebar to the map
    const sidebar = L.control.sidebar("sidebar").addTo(map);
    sidebar.open("home");

    // define an empty array to hold the sidebar selected content
    const chapterContent = [];
    // define an empty array to hold the selected county
    const chapterSelected = [];
    // define sidebar info
    const info = document.getElementById("content-info");
    // define an empty array to hold the counties
    const chapterNames = [];

    // add a basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 11,
      minZoom: 7
    }).addTo(map);

    // Remove the default zoom control 
    map.zoomControl.remove();

    // Create a legend control
    const legend = L.control({
      position: 'bottomright'
    });

    // Add a scale bar
    L.control.scale({
      position: 'bottomright'
    }).addTo(map);

    // Add the legend to the map
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML += '<h4>Legend</h4>';
      div.innerHTML += '<h5>Pipelines</h5>';
      div.innerHTML += '<svg height="12" width="12"><line x1="0" y1="6" x2="12" y2="6" style="stroke:red; stroke-width:2" /></svg> Navigator<br>';
      div.innerHTML += '<svg height="12" width="12"><line x1="0" y1="6" x2="12" y2="6" style="stroke:orange; stroke-width:2" /></svg> Midwest<br>';
      div.innerHTML += '<svg height="12" width="12"><line x1="0" y1="6" x2="12" y2="6" style="stroke:green; stroke-width:2" /></svg> Wolf<br>';
      div.innerHTML += '<h5>Counties</h5>';
      div.innerHTML += '<div class="square" style="background-color: rgba(135,206,235,0.5);"></div> Planned Pipeline Present<br>';
      div.innerHTML += '<div class="square" style="background-color: rgba(201,190,119,0.5);"></div> Pipeline Ordinance Enacted<br>';
      return div;
    };

    // Add the legend control to the map
    legend.addTo(map);

    // Adjust the CSS styles of the legend
    const legendContainer = document.querySelector('.legend');
    //legendContainer.style.paddingTop = '0px';

    // Load the data asynchronously
    d3.queue()
      .defer(d3.json, 'data/iowa-counties.geojson') //the Iowa Counties geojson file
      .defer(d3.json, 'data/pipeline-ordinances.geojson') //the county pipeline ordinances
      .defer(d3.json, 'data/Navigator_CO2_Pipeline.geojson') //Navigator Pipeline
      .defer(d3.json, 'data/Summit_CO2_Pipeline.geojson') //Summit Pipeline
      .defer(d3.json, 'data/Wolf_CO2_Pipeline.geojson') //Wolf Pipeline
      .await(drawMap); //load the layers after the map loads

    // Provide instructions for making the map
    function drawMap(err, counties, ords, nav, summit, wolf) {

      // create Leaflet object with geometry data and add to map
      const iowaCounties = L.geoJson(counties, {
        style: function(feature) {
          return {
            color: 'black',
            weight: 1,
            fillOpacity: 0
          };
        },
        onEachFeature: function(feature, layer) {
          // define the layer properties
          const props = layer.feature.properties;
          // bind a tooltip to the layer
          layer.bindTooltip('<b>' + props.name + '</b>');
          // push the county names to the chapterNames array
          chapterNames.push(props.county);
          // sort the counties alphabetically
          chapterNames.sort();
          // define the dropdown content using each county name
          const eachChapter = chapterNames.filter((v, i, a) => a.indexOf(v) === i);
          let tmpHTML = '<select><option value="0">Select a county</option>';
          for (let csv = 0; csv < eachChapter.length; csv++) tmpHTML += '<option value="' + eachChapter[csv] + '">' + eachChapter[csv] + '</option>';
          tmpHTML += '</select>';
          document.getElementById("chapter-select").innerHTML = tmpHTML;
        }
      }).addTo(map);

      // create Leaflet object with geometry data and add to map
      const pipelineCounties = L.geoJson(counties, {
        // Function to filter results based on "pipeline" property
        filter: function(feature) {
          return feature.properties.pipeline === "yes";
        },
        style: function(feature, layer) {
          return {
            color: 'black',
            weight: 1,
            fillOpacity: 0.5,
            fillColor: 'rgb(135,206,235)'
          }
        },
        onEachFeature: function(feature, layer) {
          // define the layer properties
          const props = layer.feature.properties;
          // bind a tooltip to the layer
          layer.bindTooltip('<b>' + props.name + '</b>');
        }
      }).addTo(map);

      // create Leaflet object with geometry data and add to map
      const ordinances = L.geoJson(ords, {
        // Function to filter features based on "ordinance" property
        filter: function(feature) {
          return feature.properties.ordinance === "yes";
        },
        style: function(feature, layer) {
          return {
            color: 'black',
            weight: 1,
            fillOpacity: 0.5,
            fillColor: 'rgb(201,190,119)'
          }
        },
        onEachFeature: function(feature, layer) {
          // define the layer properties
          const props = layer.feature.properties;
          // bind a tooltip to the layer
          layer.bindTooltip('<b>' + props.name + '</b><br>Click this county for details about the ordinance.');

          if (props.url && props.url2) {
            // If both "url" and "url2" properties exist, add a click event listener to the layer
            layer.on('click', function() {
              const url = props.url;
              const url2 = props.url2;
              window.open(url, '_blank');
              setTimeout(function() {
                window.open(url2, '_blank');
              }, 100);
            });
          } else if (props.url && !props.url2) {
            // If only "url" property exists, add a click event listener to the layer
            layer.on('click', function() {
              const url = props.url;
              window.open(url, '_blank');
            });
          }
        }
      });

      const navigatorPipeline = L.geoJson(nav, {
        style: function(feature) {
          return {
            color: 'red',
            weight: 2
          };
        },
        /*
                onEachFeature: function(feature, layer) {
                  // define the layer properties
                  const props = layer.feature.properties;
                  // bind a tooltip to the layer
                  layer.bindTooltip('<b>'+props.Name+'</b>', { sticky: true }).openTooltip();
                  //define what happens on mouseover
                  layer.on("mouseover", function(e) {
                    e.target.setStyle({
                      color: 'yellow',
                      weight: 3
                    });
                  });
                  //define what happens on mouseout
                  layer.on("mouseout", function(e) {
                    e.target.setStyle({
                      color: 'red',
                      weight: 2
                    });
                  });
                }
        */
      }).addTo(map);

      const summitPipeline = L.geoJson(summit, {
        style: function(feature) {
          return {
            color: 'orange',
            weight: 2
          };
        },
        /*
                onEachFeature: function(feature, layer) {
                  // define the layer properties
                  const props = layer.feature.properties;
                  // bind a tooltip to the layer
                  layer.bindTooltip('<b>'+props.Name+'</b>', { sticky: true }).openTooltip();
                  //define what happens on mouseover
                  layer.on("mouseover", function(e) {
                    e.target.setStyle({
                      color: 'yellow',
                      weight: 3
                    });
                  });
                  //define what happens on mouseout
                  layer.on("mouseout", function(e) {
                    e.target.setStyle({
                      color: 'orange',
                      weight: 2
                    });
                  });
                }
        */
      }).addTo(map);

      const wolfPipeline = L.geoJson(wolf, {
        style: function(feature) {
          return {
            color: 'green',
            weight: 2
          };
        },
        /*
                onEachFeature: function(feature, layer) {
                  // define the layer properties
                  const props = layer.feature.properties;
                  // bind a tooltip to the layer
                  layer.bindTooltip('<b>Wolf Carbon Pipeline</b>', { sticky: true }).openTooltip();
                  //define what happens on mouseover
                  layer.on("mouseover", function(e) {
                    e.target.setStyle({
                      color: 'yellow',
                      weight: 3
                    });
                  });
                  //define what happens on mouseout
                  layer.on("mouseout", function(e) {
                    e.target.setStyle({
                      color: 'green',
                      weight: 2
                    });
                  });
                }
        */
      }).addTo(map);

      // first set the zoom/center to the dataLayer's extent
      map.fitBounds(iowaCounties.getBounds());

      // Create an object with the overlay layers
      const groupedOverlays = {
        "Pipeline Layers": {
          "Navigator": navigatorPipeline,
          "Midwest": summitPipeline,
          "Wolf": wolfPipeline
        },
        "County Layers": {
          "Planned Pipeline Present": pipelineCounties,
          "Pipeline Ordinance Enacted": ordinances
        }
      };

      // Add the layer control to the map
      const layerControl = L.control.groupedLayers(null, groupedOverlays, { position: 'topright', collapsed: false, exclusiveGroups: ["County Layers"] }).addTo(map);

      // Prevent zooming when clicking on the layer control
      L.DomEvent.disableClickPropagation(layerControl.getContainer());

      // Bring the pipelines to the front whenever the counties layers are changed
      map.on('layeradd', function(eventLayer) {
        navigatorPipeline.bringToFront();
        summitPipeline.bringToFront();
        wolfPipeline.bringToFront();
      });

      $('#chapter-select')[0].onchange = function(e) {
        filterOrdinances(ordinances);
      };

    } // end drawMap function

    function filterOrdinances(ordinances) {
      chapterContent.length = 0;
      info.innerHTML = chapterContent.join("");
      chapterSelected.length = 0;
      chapterSelected.push($('#chapter-select')[0].value);
      ordinances.eachLayer(function(layer) {
        const props = layer.feature.properties;
        if (chapterSelected[0] == props.county) {
          //selectedLayers.addLayer(layer);
          chapterContent.push("<div class='story'><h2 class='about'>" + props.name + "</h2><br><h3 class='details'>" + props.Ordinance_Hyperlinks + "</h3></div>");
          info.innerHTML = chapterContent;
        }
      });
    }

  </script>

</body>

</html>
